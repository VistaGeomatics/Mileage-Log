<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mileage Log v2.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}
h1 {
  margin-top: 0;
}
.card {
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  box-shadow: 0 4px 14px rgba(0,0,0,.08);
  margin-bottom: 20px;
}
label {
  display: block;
  font-weight: 600;
  margin-top: 10px;
}
input, textarea, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
}
th {
  background: #f0f2f5;
}
button {
  background: #1f6feb;
  color: white;
  border: none;
  cursor: pointer;
  margin-top: 12px;
}
button.secondary {
  background: #6c757d;
}
.row-actions {
  display: flex;
  gap: 10px;
}
.photo-preview {
  max-width: 100%;
  margin-top: 10px;
  border-radius: 8px;
}
.footer {
  font-size: 12px;
  color: #666;
  margin-top: 20px;
}
</style>
</head>
<body>

<h1>Mileage Log</h1>

<div class="card">
  <label>Driver Name</label>
  <input id="driverName">

  <label>Primary Licence Plate</label>
  <input id="plate">

  <label>Start Odometer</label>
  <input id="startOdo" type="number">

  <label>Odometer Photo</label>
  <input id="odoPhoto" type="file" accept="image/*">
  <img id="odoPreview" class="photo-preview" style="display:none;">
</div>

<div class="card">
  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Vehicle (Unit / Plate)</th>
        <th>Business KM</th>
        <th>Personal KM</th>
        <th>End Odometer</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <button id="addRow">+ Add Row</button>
</div>

<div class="card">
  <label>Notes</label>
  <textarea id="notes" rows="4"></textarea>
</div>

<div class="footer">
  Mileage Log v2.5 Â· Autosaves on this device
</div>

<script>
const STORAGE_KEY = "mileageLog_v25";

const driverName = document.getElementById("driverName");
const plateInput = document.getElementById("plate");
const startOdo = document.getElementById("startOdo");
const notes = document.getElementById("notes");
const tableBody = document.querySelector("#logTable tbody");
const addRowBtn = document.getElementById("addRow");
const odoPhoto = document.getElementById("odoPhoto");
const odoPreview = document.getElementById("odoPreview");

function saveData() {
  const rows = [...tableBody.querySelectorAll("tr")].map(tr => {
    const inputs = tr.querySelectorAll("input");
    return {
      date: inputs[0].value,
      vehicle: inputs[1].value,
      business: inputs[2].value,
      personal: inputs[3].value,
      end: inputs[4].value
    };
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    driverName: driverName.value,
    plate: plateInput.value,
    startOdo: startOdo.value,
    notes: notes.value,
    rows,
    photo: odoPreview.src || ""
  }));
}

function loadData() {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (!data) return;

  driverName.value = data.driverName || "";
  plateInput.value = data.plate || "";
  startOdo.value = data.startOdo || "";
  notes.value = data.notes || "";

  if (data.photo) {
    odoPreview.src = data.photo;
    odoPreview.style.display = "block";
  }

  tableBody.innerHTML = "";
  (data.rows || []).forEach(addRowFromData);
}

function recalcEndOdo(tr) {
  const business = Number(tr.children[2].querySelector("input").value) || 0;
  const personal = Number(tr.children[3].querySelector("input").value) || 0;
  const start = Number(startOdo.value) || 0;
  tr.children[4].querySelector("input").value = start + business + personal;
}

function addRowFromData(row = {}) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" value="${row.date || ""}"></td>
    <td><input value="${row.vehicle || plateInput.value}"></td>
    <td><input type="number" value="${row.business || ""}"></td>
    <td><input type="number" value="${row.personal || ""}"></td>
    <td><input type="number" readonly value="${row.end || ""}"></td>
  `;

  tr.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => {
      recalcEndOdo(tr);
      saveData();
    });
  });

  tableBody.appendChild(tr);
}

function addRow() {
  addRowFromData({});
  saveData();
}

addRowBtn.addEventListener("click", addRow);

plateInput.addEventListener("input", () => {
  const plate = plateInput.value;
  document.querySelectorAll("#logTable tbody tr td:nth-child(2) input").forEach(inp => {
    if (!inp.value) inp.value = plate;
  });
  saveData();
});

odoPhoto.addEventListener("change", () => {
  const file = odoPhoto.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    odoPreview.src = reader.result;
    odoPreview.style.display = "block";
    saveData();
  };
  reader.readAsDataURL(file);
});

// Init with 8 rows
for (let i = 0; i < 8; i++) addRow();
loadData();
</script>

</body>
</html>
